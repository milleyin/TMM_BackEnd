<?php
/**
 * 
 * @author Changhai Zhan
 *	创建时间：2016-04-08 15:36:10 */
class ThrandController extends OperatorMainController
{
	/**
	 * 默认操作数据模型
	 * @var string
	 */
	public $_class_model = 'Thrand';

	/**
	 * 查看详情
	 * @param integer $id
	 */
	public function actionView($id)
	{
		$this->addCss(Yii::app()->baseUrl.'/css/operator/main/right/thrand/view.css');
		//条件
		$criteria = new CDbCriteria;
		//关系
		$criteria->with = array(
			'Thrand_ShopsClassliy',
			'Thrand_Shops'=>array('with'=>array('Shops_Agent')),
			'Thrand_Pro'=>array('with'=>array(
				'Pro_Thrand_Dot'=>array('with'=>'Dot_Shops'),
				'Pro_Items'=>array('with'=>array(
					'Items_area_id_p_Area_id',
					'Items_area_id_m_Area_id',
					'Items_area_id_c_Area_id',
					'Items_ItemsImg',
					'Items_StoreContent'=>array('with'=>array('Content_Store')),
					'Items_Store_Manager',
					'Items_ItemsClassliy',
				)),
				'Pro_ItemsClassliy',
				'Pro_ProFare'=>array('with'=>array('ProFare_Fare')),
			))
		);
		//不等于删除
		$criteria->compare('Thrand_Shops.status', '<>' . Shops::status_del);
		//标准条件
		$criteria->addColumnCondition(array(
				'`Thrand_Shops`.`agent_id`'=>Yii::app()->operator->id,
		));
		//排序
		$criteria->order = 'Thrand_Pro.day_sort,Thrand_Pro.half_sort,Thrand_Pro.sort';
		//渲染视图
		$this->render('view', array(
			'model'=>$this->loadModel($id, $criteria)
		));
	}
	
	/**
	 * 创建
	 */
	public function actionCreate()
	{
		$this->addCss(Yii::app()->request->baseUrl . '/css/operator/main/right/thrand/form.css');
		$this->addCss(Yii::app()->request->baseUrl . '/css/operator/main/right/thrand/viewdot.css');
		//实例化 线路
		$model = new Thrand;
		//商品表
		$model->Thrand_Shops = new Shops;
		$model->Thrand_Shops->scenario = 'create_thrand';
		//加载运营商信息
		$this->_class_model = 'Agent';
		$model->Thrand_Shops->Shops_Agent = $this->loadModel(Yii::app()->operator->id, 'status=:status', array(':status'=>Agent::status_suc));
		//数据转换	
		$data = $model->dataArray($_POST);
		//ajax 验证
		if (isset($_POST['ajax']) && $_POST['ajax'] === 'thrand-form' && $model->Thrand_Shops->hasErrors())
		{
			foreach ($model->Thrand_Shops->getErrors() as $attribute=>$errors)
				$result[CHtml::activeId($model->Thrand_Shops,$attribute)] = $errors;
			echo function_exists('json_encode') ? json_encode($result) : CJSON::encode($result);
			Yii::app()->end();
		}
		if ( !$model->Thrand_Shops->hasErrors())
		{
			// 选中项目 默认一个
			$model->Thrand_Pro = $this->new_modes('Pro', 'create_thrand', !empty($data) && isset($data['Pro']) ? count($data['Pro']) : 1);
			//项目选中的价格 默认一个
			foreach ($model->Thrand_Pro as $key=>$proModel)
				$proModel->Pro_ProFare = $this->new_modes('ProFare', 'create_thrand', !empty($data) && isset($data['Pro'][$key]['ProFare']) ? count($data['Pro'][$key]['ProFare']) : 1);
		}
		//ajax 验证
		$this->_Ajax_Verify($model->Thrand_Shops, 'thrand-form');
		//提交数据
		if (isset($_POST['Shops']) &&  !$model->Thrand_Shops->hasErrors())
		{
			//赋值
			$model->Thrand_Shops->attributes = $_POST['Shops'];
			//提前验证主表
			$validate_shops = $model->Thrand_Shops->validate();
			$validate_pro = false;
			$validate_profare = false;
			if (empty($data))
			{
				$model->Thrand_Shops->addError('name', '选择景点 不可空白');
				$validate_shops = false;
			}
			else
			{
				// 赋值 并验证
				$validate_pro = $this->models_validate($model->Thrand_Pro, $data);
				$validate_profares = array();
				//分别验证
				foreach ($model->Thrand_Pro as $key=>$pro)
					$validate_profares[] = $this->models_validate($pro->Pro_ProFare, isset($data['Pro'][$key]) ? $data['Pro'][$key] : array());
				if (! in_array(false, $validate_profares))
					$validate_profare = true;
			}
			//是否通过验证
			if ($validate_shops && $validate_pro && $validate_profare)
			{
				//开启事物
				$transaction = $model->dbConnection->beginTransaction();
				try
				{
					$model->Thrand_Shops->c_id = Shops::shops_thrand;
					$model->Thrand_Shops->agent_id = $model->Thrand_Shops->Shops_Agent->id;
					$model->Thrand_Shops->status = Shops::status_offline;
					$model->Thrand_Shops->audit = Shops::audit_draft;
					//处理图片链接
					$model->Thrand_Shops->cost_info = $this->admin_img_replace($model->Thrand_Shops->cost_info);
					//处理图片链接
					$model->Thrand_Shops->book_info = $this->admin_img_replace($model->Thrand_Shops->book_info);
					if ( !$model->Thrand_Shops->save(false))
						throw new Exception("创建线路 保存主要表错误");
					
					$model->id = $model->Thrand_Shops->id;
					$model->c_id = Shops::shops_thrand;
					if ( !$model->save(false))
						throw new Exception("创建线路 保存附表错误");
					//继承标签
					$element_ids = array();
					foreach ($model->Thrand_Pro as $pro_save)
					{
						$element_ids[$pro_save->dot_id] = array(TagsElement::tags_shops_dot, $pro_save->dot_id);
						$pro_save->shops_id = $model->id;
						$pro_save->shops_c_id = Shops::shops_thrand;
						if ( !$pro_save->save(false))
							throw new Exception("创建线路 保存选中项目表错误");
						
						foreach ($pro_save->Pro_ProFare as $fare_save)
						{
							$fare_save->pro_id = $pro_save->id;
							$fare_save->thrand_id = $model->id;
							if ( !$fare_save->save(false))
								throw new Exception("创建线路 保存选中项目的选中价格表错误");
						}
					}
 					//继承点的tags
					TagsElement::select_tags_ids_save(TagsElement::select_tags_all($element_ids), $model->id, TagsElement::tags_shops_thrand, TagsElement::operator);
					//日志
					$return = $this->log('创建线路', ManageLog::operator, ManageLog::create);
					$transaction->commit();
				}
				catch(Exception $e)
				{
					//事务回滚
					$transaction->rollBack();
					$this->error_log($e->getMessage(), ErrorLog::operator, ErrorLog::create, ErrorLog::rollback, __METHOD__);
				}
			}
			else if ($validate_shops && (!$validate_pro || !$validate_profare))
				$this->getModelError($model, $validate_pro);
			if (isset($return) && $return)
				$this->redirect(array('/operator/shops/admin'));
		}
		
		$this->render('create',array(
			'model'=>$model,
			'dotModel'=>$this->dotList(),
		));
	}

	/**
	 * 景点列表
	 * @return Dot
	 */
	public function dotList()
	{
		$model = new Dot('createThrandSearch');
		$model->Dot_Shops = new Shops('createThrandSearch');
		// 删除默认属性
		$model->unsetAttributes();
		$model->Dot_Shops->unsetAttributes();
		if (isset($_GET['Dot']))
			$model->attributes = $_GET['Dot'];
		if (isset($_GET['Shops']['list_info']))
			$_GET['Shops']['name'] = $_GET['Shops']['list_info'];
		if (isset($_GET['Shops']))
			$model->Dot_Shops->attributes = $_GET['Shops'];		
		return $model;
	}
	
	/**
	 * 更新
	 * @param integer $id
	 */
	public function actionUpdate($id)
	{
		$this->addCss(Yii::app()->request->baseUrl . '/css/operator/main/right/thrand/form.css');
		$this->addCss(Yii::app()->request->baseUrl . '/css/operator/main/right/thrand/viewdot.css');
		//条件
		$criteria = new CDbCriteria;
		//关系
		$criteria->with = array(
			'Thrand_Shops'=>array('with'=>array('Shops_Agent')),
			'Thrand_Pro'=>array(
				'with'=>array(
					'Pro_Thrand_Dot'=>array(
						'with'=>array('Dot_Shops'),
					),
					'Pro_ProFare'=>array('with'=>array('ProFare_Fare')),
					'Pro_ItemsClassliy',
					'Pro_Items'=>array(
						'with'=>array(
							'Items_ItemsClassliy',
							'Items_area_id_p_Area_id',
							'Items_area_id_m_Area_id',
							'Items_area_id_c_Area_id',
							'Items_ItemsImg',
							'Items_StoreContent'=>array('with'=>array('Content_Store')),
						),
					),				
				)
			)
		);
		//线路不等于审核中
		$criteria->addCondition('`Thrand_Shops`.`audit`!=:audit');
		$criteria->params[':audit'] = Shops::audit_pending;
		//标准条件
		$criteria->addColumnCondition(array(
			'`Thrand_Shops`.`agent_id`'=>Yii::app()->operator->id,
			'`Shops_Agent`.`status`'=>Agent::status_suc,
			'`Thrand_Shops`.`status`'=>Shops::status_offline,
		));
		//排序
		$criteria->order = 'Thrand_Pro.day_sort,Thrand_Pro.half_sort,Thrand_Pro.sort';
		//加载线路
		$model = $this->loadModel($id, $criteria);
		//记录原来的pro数据
		$oldProArray = $this->listData($model->Thrand_Pro, 'id', 'id');
		//记录下原来的选择的价格
		$oldProFareArray = array();
		foreach ($model->Thrand_Pro as $oldPro)
			$oldProFareArray += $this->listData($oldPro->Pro_ProFare, 'id', 'id');
		//商品表
		$model->Thrand_Shops->scenario = 'update_thrand';
		//数据转换
		$data = $model->dataArray($_POST);
		//ajax 验证
		if (isset($_POST['ajax']) && $_POST['ajax'] === 'thrand-form' && $model->Thrand_Shops->hasErrors())
		{
			foreach ($model->Thrand_Shops->getErrors() as $attribute=>$errors)
				$result[CHtml::activeId($model->Thrand_Shops,$attribute)] = $errors;
			echo function_exists('json_encode') ? json_encode($result) : CJSON::encode($result);
			Yii::app()->end();
		}
		if ( !$model->Thrand_Shops->hasErrors() && $data)
		{
			// 更新 提交 选中项目 1
			$model->Thrand_Pro = $this->update_models($model->Thrand_Pro, (isset($data['Pro']) ? count($data['Pro']) : 1), 'update_thrand', 'Pro');
			//项目选中的价格 1
			foreach ($model->Thrand_Pro as $key=>$proModel)
				$proModel->Pro_ProFare = $this->update_models($proModel->Pro_ProFare, (isset($data['Pro'][$key]['ProFare']) ? count($data['Pro'][$key]['ProFare']) : 1), 'update_thrand', 'ProFare');
		}
		//ajax 验证
		$this->_Ajax_Verify($model->Thrand_Shops, 'thrand-form');
		//提交数据
		if (isset($_POST['Shops']) && !$model->Thrand_Shops->hasErrors())
		{
			//赋值
			$model->Thrand_Shops->attributes = $_POST['Shops'];
			//提前验证主表
			$validate_shops = $model->Thrand_Shops->validate();
			$validate_pro = false;
			$validate_profare = false;
			if (empty($data))
			{
				$model->Thrand_Shops->addError('name', '选择景点 不可空白');
				$validate_shops = false;
			}
			else
			{
				// 赋值 并验证
				$validate_pro = $this->models_validate($model->Thrand_Pro, $data);
				$validate_profares = array();
				//分别验证
				foreach ($model->Thrand_Pro as $key=>$pro)
					$validate_profares[] = $this->models_validate($pro->Pro_ProFare, isset($data['Pro'][$key]) ? $data['Pro'][$key] : array());
				if ( !in_array(false, $validate_profares) && !empty($validate_profares))
					$validate_profare = true;
			}
			//是否通过验证
			if ($validate_shops && $validate_pro && $validate_profare)
			{
				//开启事物
				$transaction = $model->dbConnection->beginTransaction();
				try
				{
					$model->Thrand_Shops->audit = Shops::audit_draft;
					//处理图片链接
					$model->Thrand_Shops->cost_info = $this->admin_img_replace($model->Thrand_Shops->cost_info);
					//处理图片链接
					$model->Thrand_Shops->book_info = $this->admin_img_replace($model->Thrand_Shops->book_info);
					if ( !$model->Thrand_Shops->save(false))
						throw new Exception("修改线路 保存主要表错误");
										
					foreach ($model->Thrand_Pro as $pro_save)
					{
						$pro_save->shops_id = $model->id;
						$pro_save->shops_c_id = Shops::shops_thrand;
						if ( !$pro_save->save(false))
							throw new Exception("修改线路 保存选中项目表错误");
						
						foreach ($pro_save->Pro_ProFare as $fare_save)
						{
							$fare_save->pro_id = $pro_save->id;
							$fare_save->thrand_id = $model->id;
							if ( !$fare_save->save(false))
								throw new Exception("修改线路 保存选中项目的选中价格表错误");
							if (isset($oldProFareArray[$fare_save->id]))
								unset($oldProFareArray[$fare_save->id]);
						}
						if (isset($oldProArray[$pro_save->id]))
							unset($oldProArray[$pro_save->id]);
					}
					if ( !empty($oldProArray))
					{
						$oldProCriteria = new CDbCriteria;
						$oldProCriteria->addInCondition('id', $oldProArray);
						if ( !Pro::model()->deleteAll($oldProCriteria))
							throw new Exception("修改线路 删除多余的选择项目表 错误");
					}
					if ( !empty($oldProFareArray))
					{
						$oldProFareCriteria = new CDbCriteria;
						$oldProFareCriteria->addInCondition('id', $oldProFareArray);
						if ( !ProFare::model()->deleteAll($oldProFareCriteria))
							throw new Exception("修改线路 删除多余的项目选中价格表 错误");
					}
					//日志
					$return = $this->log('修改线路', ManageLog::operator, ManageLog::update);
					$transaction->commit();
				}
				catch(Exception $e)
				{
					//事务回滚
					$transaction->rollBack();
					$this->error_log($e->getMessage(), ErrorLog::operator, ErrorLog::update, ErrorLog::rollback, __METHOD__);
				}
			}
			else if ($validate_shops && (!$validate_pro || !$validate_profare))
				$this->getModelError($model, $validate_pro);
			if (isset($return) && $return)
				$this->redirect(array('/operator/shops/admin'));
		}

		$this->render('update',array(
			'model'=>$model,
			'dotModel'=>$this->dotList(),
		));
	}
	
	/**
	 * 选择点中项目
	 * @param unknown $id
	 */
	public function actionViewdot($id)
	{
		$this->_class_model = 'Dot';
		//条件
		$criteria = new CDbCriteria;
		//关系
		$criteria->with = array(
			'Dot_Shops'=>array(
				'select'=>'name, status',
				'with'=>array('Shops_Agent'),
			),
			'Dot_Pro'=>array(
				'with'=>array(
					'Pro_ItemsClassliy',
					'Pro_Items'=>array(
						'with'=>array(
							'Items_agent',
							'Items_ItemsClassliy',
							'Items_area_id_p_Area_id'=>array('select'=>'name'),
							'Items_area_id_m_Area_id'=>array('select'=>'name'),
							'Items_area_id_c_Area_id'=>array('select'=>'name'),
							'Items_ItemsImg'=>array('select'=>'img'),
							'Items_Store_Manager',
							'Items_StoreContent'=>array('with'=>array('Content_Store')),
							'Items_Fare',
						),
					),
				)
			)
		);
		//条件
		$criteria->addColumnCondition(array(
			'`Dot_Shops`.`status`'=>Shops::status_online,
			'`Dot_Shops`.`audit`'=>Shops::audit_pass,
			'`Pro_Items`.`status`'=>Items::status_online,
			'`Pro_Items`.`audit`'=>Items::audit_pass,
			'`Shops_Agent`.`status`'=>Agent::status_suc,
			'`Items_agent`.`status`'=>Agent::status_suc,
			'`Items_Store_Manager`.status'=>StoreUser::status_suc,
			'`Content_Store`.`status`'=>StoreUser::status_suc,
		));
		//排序
		$criteria->order = 'Dot_Pro.sort';
		//渲染视图
		$this->renderPartial('viewdot', array(
			'model'=>$this->loadModel($id, $criteria),
		));
	}
	
	/**
	 * 获取错误
	 * @param unknown $model
	 * @param unknown $validate_pro
	 */
	public function getModelError($model, $validate_pro)
	{
		if (!$validate_pro)
		{
			foreach ($model->Thrand_Pro as $proErrors)
			{
				if ($proErrors->hasErrors())
				{
					$model->Thrand_Shops->addError('name', current(current($proErrors->getErrors())));
					return $model;
				}
			}
		}
		else
		{
			foreach ($model->Thrand_Pro as $proErrors)
			{
				foreach ($proErrors->Pro_ProFare as $fareErrors)
				{
					if ($fareErrors->hasErrors())
					{
						$model->Thrand_Shops->addError('name', current(current($fareErrors->getErrors())));
						return $model;
					}
				}
			}
		}
	}
}
