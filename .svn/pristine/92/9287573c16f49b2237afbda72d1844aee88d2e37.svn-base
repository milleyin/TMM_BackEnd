<?php

class AdminModule extends WebModule
{
	public function init()
	{
		// this method is called when the module is being created
		// you may place code here to customize the module or the application
		// import the module-level models and components
		//后台默认主题
		Yii::app()->theme = 'html';
		$this->setImport(array(
			$this->getId() . '.models.*',
			$this->getId() . '.components.*',
		));
		Yii::app()->setComponents(array(
			'errorHandler'=>array(
				'class'=>'CErrorHandler',
				'errorAction'=>YII_DEBUG ? null : '/' . $this->getId() . '/error/index',
			),
			'user'=>array(
				'class'=>'AdminWebUser',
				'stateKeyPrefix'=>$this->getId(),									//后台session前缀
				'loginUrl'=>array('/' . $this->getId() . '/login/index'),
				'loginRequiredAjaxResponse'=>array('/' . $this->getId() . '/login/index'),
				'authTimeout'=>1440,
				//'allowAutoLogin'=>true,									//自动登录
				//'autoRenewCookie'=>true,								//自动登录的时候刷新Cooike的时间
				//'identityCookie'=>array('httpOnly'=>true),	//防止JS修改Cookie
			),
//  			'session' => array(
//  				'class'=>'CHttpSession',
//  				'timeout' =>1440,
//  				'cookieParams'=>array('httponly'=>true), 		//防止JS修改Cookie
//  				'cookieMode'=>'only',										//保存SessionID 仅仅用Cookie的方式保存
//  			),
		), false);
	}

	/**
	 * 进入控制器之前的操作
	 * (non-PHPdoc)
	 * @see WebModule::beforeControllerAction()
	 */
	public function beforeControllerAction($controller, $action)
	{
		if (parent::beforeControllerAction($controller, $action))
		{
			$route = $controller->id . '/' . $action->id;
			if ( !Helper::allowIp(Yii::app()->request->userHostAddress, $this->ipFilters) && $route !== 'error/index')
				throw new CHttpException(403, "没有权限访问系统。");
			$publicPages = array(
				'error/index',
				'login/index',
				'login/captcha',
			);
			if (Yii::app()->user->isGuest && !in_array($route, $publicPages))
				Yii::app()->user->loginRequired();
			elseif( !in_array($route,$publicPages))
				return true;
			return true;
		}
		else
			return false;
	}
}
