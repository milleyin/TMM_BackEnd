<?php
namespace Litchi\Controller;
use Think\Controller;

/**
 * 荔枝文化节创意自拍
 * Class VoteController
 * @package Litchi\Controller
 *
 * @author Moore Mo
 */
class VoteController extends Controller {
    /**
     * @var String 微信id
     */
    protected $wechatid;
    /**
     * @var Array 微信用户信息
     */
    protected $wxUserInfo;

    public function _initialize() {
        $this->wechatid = A('Common/Weixin')->getOpenid();
        $this->wxUserInfo = A('Common/Weixin')->getWxUserInfo($this->wechatid);
        //$this->wechatid = 'o_CytuIwPE8e5yHoLQgPzXgRePTM';
    }

    /**
     * 奖品设置页
     */
    public function rewards() {
        $this->assign('title', '荔枝节文化节创意自拍奖品及参赛规则');
        $this->display('rewards');
    }

    /**
     * 参赛者详情
     */
    public function detail() {
        $this->_isSubscribe();

        $id = I('get.id');
        if (! is_numeric($id)) {
            $this->error('非法操作');
        }

        $racingInfo = M('LzRacing')->where(array('id'=> $id, 'status' => 1))->find();
        if (empty($racingInfo)) {
            $this->error('无此参赛者信息');
        }

        // 统计名次和距上一名相差多少票
        $racingInfo['rankInfo'] = $this->_rankInfo($racingInfo['id']);

        // 查找参赛者照片信息
        $imgList = M('LzRacingImg')->where(array('to_id' => $racingInfo['id']))->select();
        $racingInfo['imgList'] = $imgList;

        // 是否报过名
        $racingInfo['isApply'] = $this->_isApply($this->wechatid);
        // 今天是否可以对该参赛者投票
        $racingInfo['isCanVote'] = $this->_isCanVote($racingInfo['id'], $this->wechatid);

        // 报名成功过来的闪存，用于报名成功后第一次进入详情页时的提示
        $applyFlash = S('applyFlash'.$id);
        // 删除闪存
        S('applyFlash'.$id, null);

        // 检测活动是否已结束
        $this->assign('isEnd', $this->_isEndActivity());
        $this->assign('racingInfo', $racingInfo);
        $this->assign('applyFlash', $applyFlash);
        $this->assign('title', "我是{$racingInfo['nickname']}，正在参加天美荔枝文化节“创意自拍大赛”，快来投我一票吧！");
        $this->display('detail');
    }

    /**
     * 查询参赛者
     */
    public function findRacing() {
        !IS_AJAX && $this->redirect('Vote/index');

        $back = new \stdClass();

        $keyword = I('post.keyword', '', 'trim');
        if (empty($keyword)) {
            $back->status = 0;
            $back->prompt = '请输入编号或名字查找';
            $this->ajaxReturn($back);
        }

        // 查询条件
        if (is_numeric($keyword)) {
            $condition['id'] = $keyword;
        } else {
            $condition['nickname'] = $keyword;
        }

        $info = M('LzRacing')->where($condition)->find();
        if (empty($info)) {
            $back->status = 0;
            $back->prompt = '无此参考者';
            $this->ajaxReturn($back);
        }

        $back->status = 1;
        $back->data = array('id' => $info['id']);
        $this->ajaxReturn($back);
    }

    /**
     * 参赛首页 （最新参赛）
     */
    public function index() {
        $this->_isSubscribe();

        // 1 最新参赛 2投票排行
        $type = I('get.type', 1, 'intval');

        // 查询出所有参赛者
        $racingList = $this->_racingList($type);

        // 首次加载有数据了，那么异步加载的时候从第二页开始加载了,否则从第一页开始
        $page = empty($racingList) ? 1 : 2;

        $racingInfo = M('LzRacing')->where(array('wechatid' => $this->wechatid))->find();
        if (empty($racingInfo)) {
            // 没报过名
            $this->assign('isApply', false);
        } else {
            // 已经报过名
            $this->assign('racingId', $racingInfo['id']);
            $this->assign('isApply', true);
        }

        // 已报名人数
        $this->assign('userNum', $this->_racingUserCount());
        // 投票人数
        $this->assign('voteNum', $this->_voteUserCount());
        // 检测活动是否已结束
        $this->assign('isEnd', $this->_isEndActivity());
        $this->assign('racingList', $racingList);
        $this->assign('type', $type);
        $this->assign('page', $page);
        $this->assign('title', '荔枝节文化节创意自拍参赛首页');
        $this->display('index');
    }

    /**
     * 获取更多参赛者
     */
    public function getMoreRacing() {
        if (IS_AJAX) {
            $type = I('get.type', 1, 'intval');
            $list = $this->_racingList($type);
            $this->ajaxReturn($list);
        }
    }

    /**
     * 报名
     * return 0 报名失败 1报名成功 2未关注公众号 3已报过名
     */
    public function apply() {
        if (IS_AJAX) {
            $back = new \stdClass();

            // 判断是否关注了公众号
            if ($this->wxUserInfo['subscribe'] == 0) {
                $back->status = 2;
                $back->prompt = '请先关注“田觅觅”公众号';
                $this->ajaxReturn($back);
            }

            // 检测活动是否结束
            if ($this->_isEndActivity()) {
                $back->status = 0;
                $back->prompt = '活动已结束';
                $this->ajaxReturn($back);
            }

            // 获取图片数组1-5张
            $imageList = I('post.file_upload', '', 'trim');

            $data = array(
                'wechatid' => $this->wechatid,
                'nickname' => I('post.nickname', '', 'trim'),
                'mobile' => I('post.mobile', '', 'trim'),
                'introduce' => I('post.introduce', '我和荔枝的前世今生，最美还是我。', 'trim'),
                'racing_time' => time()
            );

            if (empty($data['nickname'])) {
                $back->status = 0;
                $back->prompt = '昵称不能为空';
                $this->ajaxReturn($back);
            }
            if (! isMobile($data['mobile'])) {
                $back->status = 0;
                $back->prompt = '联系电话无效';
                $this->ajaxReturn($back);
            }
            if (count($imageList) <=0 || count($imageList) > 5) {
                // 图片个数检测1-5张
                $back->status = 0;
                $back->prompt = '上传照片只能1-5张';
                $this->ajaxReturn($back);
            }

            $racingModel = M('LzRacing');
            // 重复报名检测
            $racingInfo = $racingModel->where(array('wechatid' => $this->wechatid))->find();
            if (empty($racingInfo)) {
                // 开户事务
                $racingModel->startTrans();
                try {
                    $racingInfo = $racingModel->where(array('wechatid' =>  $this->wechatid))->find();
                    // 重复报名检测
                    if (! empty($racingInfo)) {
                        throw new \Exception('您已报过名');
                    }
                    $racingInfo = $racingModel->where(array('mobile' =>  $data['mobile']))->find();
                    // 手机号重复检测
                    if (! empty($racingInfo)) {
                        throw new \Exception('此手机号已报过名');
                    }
                    $id = $racingModel->add($data);
                    if ($id) {
                        // 插入图片
                        if ($this->_addRaceImg($id, $imageList)) {
                            // 事务提交
                            $racingModel->commit();

                            S('applyFlash'.$id, 1);
                            $back->status = 1;
                            $back->prompt = '报名成功';
                            $back->data = array('url' => U('Vote/detail', array('id'=>$id), true, true));
                            $this->ajaxReturn($back);
                        } else {
                            throw new \Exception('报名失败，上传图片出错');
                        }
                    } else {
                        throw new \Exception('报名失败');
                    }
                } catch(\Exception $e) {
                    // 事务回滚
                    $racingModel->rollback();
                    $back->status = 0;
                    $back->prompt = $e->getMessage();
                    $this->ajaxReturn($back);
                }
            } else {
                $back->status = 3;
                $back->prompt = '您已报过名';
                $this->ajaxReturn($back);
            }
        }

        $this->_isSubscribe();
        // 重复报名检测
        $racingInfo = M('LzRacing')->where(array('wechatid' => $this->wechatid))->find();
        if (! empty($racingInfo)) {
            $this->error('您已报过名');
        }
        $this->assign('nickname', $this->wxUserInfo['nickname']);
        $this->display('apply');
    }

    /**
     * 上传图片
     */
    public function uploadImg() {
        ! IS_AJAX && $this->redirect('Vote/index');

        $upload = new \Think\Upload(); // 实例化上传类
        $upload->maxSize = 3145728; // 设置上传附件大小
        $upload->exts = array('jpg', 'gif', 'png', 'jpeg'); // 设置上传文件类型
        $upload->rootPath = './Uploads/';
        $upload->savePath = '/Litchi/Temp/';

        $back = new \stdClass();

        // 上传文件
        $info = $upload->upload();
        if (! $info) {
            // 上传错误提示
            $back->status = 0;
            $back->prompt = $upload->getError();
            $this->ajaxReturn($back);
        }
        // 清空缓存目录的图片
        clearTemp($upload->rootPath . $upload->savePath);

        $back->status = 1;
        $back->data = array('path' => $upload->rootPath . $info[0]['savepath'] . $info[0]['savename']);
        $back->prompt = '上传成功';
        $this->ajaxReturn($back);
    }

    /**
     * 投票
     * return 0投票失败 1投票成功 2未关注公众号
     */
    public function vote() {
        ! IS_AJAX && $this->redirect('Vote/index');

        $back = new \stdClass();

        // 判断是否关注了公众号
        if ($this->wxUserInfo['subscribe'] == 0) {
            $back->status = 2;
            $back->prompt = '请先关注“田觅觅”公众号';
            $this->ajaxReturn($back);
        }

        // 检测活动是否结束
        if ($this->_isEndActivity()) {
            $back->status = 0;
            $back->prompt = '活动已结束';
            $this->ajaxReturn($back);
        }

        $voteLogData = array(
            'to_id' => I('post.id'),
            'from_id' => $this->wechatid,
            'vote_ip' => get_client_ip(),
            'create_time' => time()
        );

        // 参赛者id
        if (! is_numeric($voteLogData['to_id'])) {
            $back->status = 0;
            $back->prompt = '非法操作';
            $this->ajaxReturn($back);
        }


        $racingModel = M('LzRacing');
        $voteLogModel = M('LzVoteLog');

        $racingInfo = $racingModel->where(array('id' => $voteLogData['to_id']))->find();
        if (empty($racingInfo)) {
            $back->status = 0;
            $back->prompt = '抱歉，服务器繁忙，请稍候再试';
            $this->ajaxReturn($back);
        }

        // 每天每人对同一参赛者只能投一票
        $condition['to_id'] = $voteLogData['to_id'];
        $condition['from_id'] = $this->wechatid;
        $condition['create_time'] = array('between', array(strtotime(date('Y-m-d', time()) . '00:00:00'), strtotime(date('Y-m-d', time()) . '23:59:59')));
        $oneInfo = $voteLogModel->where($condition)->find();

        if (! empty($oneInfo)) {
            $back->status = 0;
            $back->prompt = '今天您已投过票，请明天再来';
            $this->ajaxReturn($back);
        }

        // 开户事务
        $voteLogModel->startTrans();
        try {
            // 每天每人对同一参赛者只能投一票
            $oneInfo = $voteLogModel->where($condition)->find();
            if (empty($oneInfo)) {
                // 每人每天只有5票
                unset($condition['to_id']);
                $count = $voteLogModel->where($condition)->count();
                if (intval($count) >= 5) {
                    throw new \Exception('您今天票已用完，请明天再来');
                } else {
                    // 验证通过，插入投票数据
                    $id = $voteLogModel->add($voteLogData);
                    if ($id) {
                        if ($this->_incPoll($voteLogData['to_id'])) {
                            // 事务提交
                            $voteLogModel->commit();
                            $back->status = 1;
                            $back->prompt = '投票成功';
                            $this->ajaxReturn($back);
                        } else {
                            throw new \Exception('投票失败，请重试');
                        }
                    } else {
                        throw new \Exception('投票失败，请重试');
                    }
                }
            } else {
                throw new \Exception('今天您已投过票，请明天再来');
            }
        } catch(\Exception $e) {
            // 事务回滚
            $voteLogModel->rollback();
            $back->status = 0;
            $back->prompt = $e->getMessage();
            $this->ajaxReturn($back);
        }
    }

    /**
     * 关注公众号
     */
    public function follow() {
        $this->display('follow');
    }

    /**
     * 参赛者列表
     * @param int $type 1 最新参赛 2 最新排行
     * @return mixed
     */
    private function _racingList($type = 1) {
        if ($type == 2) {
            $order = array('poll' => 'desc','id'=>'desc');
        } else {
            $order = array('racing_time' => 'desc','id'=>'desc');
        }

        $racingModel = M('LzRacing'); // 实例化User对象
        $count      = $racingModel->where('status=1')->count();// 查询满足要求的总记录数
        $Page       = new \Think\Page($count, 10);// 实例化分页类 传入总记录数和每页显示的记录数(25)
        // 进行分页数据查询 注意limit方法的参数要使用Page类的属性
        $racingList = $racingModel->where(array('audit_status'=>1, 'status'=>1))->order($order)->limit($Page->firstRow.','.$Page->listRows)->select();
        // 随机取一张照片
        $racingImg = M('LzRacingImg');
        foreach($racingList as $key => $val) {
            $racingImgList = $racingImg->where(array('to_id' => $val['id']))->select();
            // 随机取一张图片
            $racingList[$key]['racingImg'] = $racingImgList[array_rand($racingImgList)]['img_url'];
        }
        return $racingList;
    }

    /**
     * 统计指定参赛者的排名和距上一名还差多少票
     * @param $id 参赛者id
     * @return array
     */
    private function _rankInfo($id) {
        $model = new \Think\Model(); // 实例化一个model对象 没有对应任何数据表
        // poll票数 rank名次
        $sql = "SELECT * FROM (SELECT id,poll,(@rank:=@rank+1) AS rank FROM __LZ_RACING__,(SELECT (@rank:=0)) b ORDER BY poll DESC, id DESC) c WHERE id={$id}";
        // 返回的是一个二维数组，取第一维
        $rankInfo = $model->query($sql);
        $rank = intval($rankInfo[0]['rank']);

        // 距上一名还差多少票
        $sql = "SELECT * FROM (SELECT id,poll,(@rank:=@rank+1) AS rank FROM __LZ_RACING__,(SELECT (@rank:=0)) b ORDER BY poll DESC, id DESC) c WHERE rank=".($rank - 1);
        $preRankInfo = $model->query($sql);

        return array(
            'rank' => $rank,
            'difPoll' => $preRankInfo[0]['poll'] - $rankInfo[0]['poll']
        );
    }

    /**
     * 增加参赛图片 1-5张
     * @param $id 参赛者id
     * @param $list 图片列表
     * @return bool|string
     */
    private function _addRaceImg($id, $list) {
        if (! $id) {
            return false;
        }
        if (count($list) <=0 || count($list) > 5) {
            return false;
        }
        $imgData = array();
        $isOk = true;
        $cThumb = new \Common\Library\Util\CThumb();
        foreach ($list as $val) {

            $fileInfo = pathinfo(basename($val));
            $filename = $fileInfo['filename'];
            $new_path = dirname($val) . '/';

            // 压缩图片
            $compressImgConfig = C('COMPRESS_IMG_CONFIG');
            $cThumb->image = $val;
            $cThumb->mode = 4;
            $cThumb->quality = $compressImgConfig['app']['quality'];
            $cThumb->compression =  $compressImgConfig['app']['compression'];
            $cThumb->width = $compressImgConfig['app']['with'];
            $cThumb->height = $compressImgConfig['app']['height'];
            $cThumb->directory = $new_path;
            $cThumb->defaultName = $filename;
            $cThumb->setSrcExt(pathinfo($val, PATHINFO_EXTENSION));
            $cThumb->createThumb();
            $cThumb->save();

            // 把临时目替换成真实目录
            $newValPath = str_replace("Temp", "Picture", $val);

            $imgData[] = array(
                'to_id' => $id,
                'img_url' => $newValPath,
                'upload_time' => time(),
            );

            // 压缩完后，把图片移动到真实保存目录
            if(!is_dir(dirname($newValPath))) {
                mkdir(dirname($newValPath), 0777, true);
            }
            $isOk = rename($val, $newValPath);
            if ($isOk === false) {
                break;
            }
        }
        if ($isOk) {
            $racingImgModel = M('LzRacingImg');
            return $racingImgModel->addAll($imgData);
        }
        return false;
    }

    /**
     * 参赛者票数加1
     * @param $id 参赛者id
     * @return bool
     */
    private function _incPoll($id) {
        return M('LzRacing')->where(array('id' => $id))->setInc('poll'); // 用户的积分加1
    }

    /**
     * 统计已报名人数
     * @return int
     */
    private function _racingUserCount() {
        $count = M('LzRacing')->count('id');
        return intval($count);
    }

    /**
     * 统计投票人数
     * @return int
     */
    private function _voteUserCount() {
        $count = M('LzVoteLog')->count('distinct from_id');

        // 查询出总共投的票数
        //$total_poll = M('LzRacing')->sum('poll');
        //$newCount = floor($total_poll / 2.8);

        return intval($count);
    }

    /**
     * 判断是否已经报过名
     * @param $wechatid
     * @return bool
     */
    private function _isApply($wechatid) {
        $info =  M('LzRacing')->where(array('wechatid' => $wechatid))->find();
        if (empty($info)) {
            return false;
        }
        return true;
    }

    /**
     * 判断今天是否还可以投票
     * @param $toId
     * @param $wechatid
     * @return bool
     */
    private function _isCanVote($toId, $wechatid) {
        // 每天每人对同一参赛者只能投一票
        $condition['to_id'] = $toId;
        $condition['from_id'] = $wechatid;
        $condition['create_time'] = array('between', array(strtotime(date('Y-m-d', time()) . '00:00:00'), strtotime(date('Y-m-d', time()) . '23:59:59')));
        $info = M('LzVoteLog')->where($condition)->find();
        //如果今天已经对指定参赛者投过票，返回false
        if (! empty($info)) {
            return false;
        }
        return true;
    }

    /**
     * 检测活动是否已结束
     * @return bool true活动已结束 false活动未结束
     */
    private function _isEndActivity() {
        $actConfig = C('ACTIVITY_CONFIG');
        return time() > strtotime($actConfig['end_time']);
    }

    /**
     * 判断是否关注了公众号
     */
    private function _isSubscribe() {
        if ($this->wxUserInfo['subscribe'] == 0) {
            $this->redirect('Vote/follow');
        }
    }

}