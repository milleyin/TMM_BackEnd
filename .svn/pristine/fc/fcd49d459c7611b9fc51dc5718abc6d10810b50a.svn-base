<?php

/**
 * This is the model class for table "{{pad}}".
 *
 * The followings are the available columns in table '{{pad}}':
 * @property string $id
 * @property string $store_id
 * @property string $name
 * @property string $number
 * @property string $mac
 * @property integer $state
 * @property string $up_time
 * @property string $add_time
 * @property integer $status
 */
class Pad extends ActiveRecord
{
    /**
     * 解释字段 status 的含义
     * @var array
     */
    public static $_status = array(
            self::_STATUS_DELETED => '已解绑',
            self::_STATUS_DISABLE => '已禁用',
            self::_STATUS_NORMAL => '已绑定',
    );
    
    /********************************  STATE设备状态 **********************************/
    /**
     * 异常
     *     @var integer
     */
    const PAD_STATE_ABNORMAL = -1;
    /**
     * 检查中
     * @var integer
     */
    const PAD_STATE_DETECTION = 0;
    /**
     * 正常
     * @var integer
     */
    const PAD_STATE_NORMAL = 1;
    /**
     * 解释字段 state 的含义
     * @var array
     */
    public static $_state = array(
            self::PAD_STATE_ABNORMAL => '异常',
            self::PAD_STATE_DETECTION => '检查中',
            self::PAD_STATE_NORMAL => '正常'
    );
    
    /**
     * @return string the associated database table name
     */
    public function tableName()
    {
        return '{{pad}}';
    }

    /**
     * @return array validation rules for model attributes.
     */
    public function rules()
    {
        // NOTE: you should only define rules for those attributes that
        // will receive user inputs.
        return array(
            //array('store_id', 'required'),
            array('state, status', 'numerical', 'integerOnly'=>true),
            array('store_id', 'length', 'max'=>20),
            array('name', 'length', 'max'=>16),
            array('number, mac', 'length', 'max'=>128),
            array('up_time, add_time', 'length', 'max'=>10),
            array('number, mac', 'length', 'max'=>20),
                
            array('state', 'in', 'range'=>array_keys(self::$_state)),
            array('status', 'in', 'range'=>array_keys(self::$_status)),
            //唯一 除解绑的
            array('number', 'unique', 'criteria'=>array('condition'=>'status!=:status', 'params'=>array(':status'=>self::_STATUS_DELETED))),
            //创建 修改
            array('name, number', 'required', 'on'=>'create, update'),
            array('name, number, mac', 'safe', 'on'=>'create, update'),
            array('id, store_id, state, up_time, add_time, status', 'unsafe', 'on'=>'create, update'),
            // The following rule is used by search().
            // @todo Please remove those attributes that should not be searched.
            array('id, store_id, name, number, mac, state, up_time, add_time, status', 'safe', 'on'=>'search'),
        );
    }

    /**
     * @return array relational rules.
     */
    public function relations()
    {
        // NOTE: you may need to adjust the relation name and the related
        // class name for the relations automatically generated below.
        return array(
            'Pad_Store' => array(self::BELONGS_TO, 'Store', 'store_id'),
            'Pad_Role' => array(self::BELONGS_TO, 'Role', 'store_id'),
            'Pad_Config' => array(self::HAS_ONE, 'Config', 'pad_id'),
        );
    }

    /**
     * @return array customized attribute labels (name=>label)
     */
    public function attributeLabels()
    {
        return array(
            'id' => 'ID',
            'store_id' => '体验店',
            'name' => '展示屏名称',
            'number' => 'MAC地址',
            'mac' => 'IMEI号',
            'state' => '监控状态',
            'up_time' => '修改时间',
            'add_time' => '绑定时间',
            'status' => '状态',
        );
    }

    /**
     * Retrieves a list of models based on the current search/filter conditions.
     *
     * Typical usecase:
     * - Initialize the model fields with values from filter form.
     * - Execute this method to get CActiveDataProvider instance which will filter
     * models according to data in model fields.
     * - Pass data provider to CGridView, CListView or any similar widget.
     *
     * @return CActiveDataProvider the data provider that can return the models
     * based on the search/filter conditions.
     */
    public function search()
    {
        // @todo Please modify the following code to remove attributes that should not be searched.
        $criteria = new CDbCriteria;
        $criteria->with = array(
            'Pad_Store',
            'Pad_Config'=>array('select'=>'id'),
        );
        $criteria->compare('t.id', $this->id, true);        
        if (strpos($this->store_id, '=') === 0)
          $criteria->compare('t.store_id', $this->store_id);
        else
          $criteria->compare('Pad_Store.store_name', $this->store_id, true);
        $criteria->compare('Pad_Store.phone', $this->Pad_Store->phone, true);
        $criteria->compare('t.name', $this->name,true);
        $criteria->compare('t.number', $this->number,true);
        $criteria->compare('t.mac', $this->mac,true);
        $criteria->compare('t.state', $this->state);
        $this->timeSearch('t.up_time', $criteria, $this->up_time);
        $this->timeSearch('t.add_time', $criteria, $this->add_time);
        if ($this->status != self::_STATUS_DELETED)
            $criteria->compare('t.status', '<>' . self::_STATUS_DELETED);
        $criteria->compare('t.status', $this->status);
        
        if ( (!!$area = Area::model()->validateAttribute('city', $this->Pad_Store->city)) && $area->pid != $this->Pad_Store->province)
            $this->Pad_Store->city = $this->Pad_Store->district = '';
        
        $criteria->compare('Pad_Store.name', $this->Pad_Store->name, true);
        $criteria->compare('Pad_Store.telephone', $this->Pad_Store->telephone, true);
        $criteria->compare('Pad_Store.province', $this->Pad_Store->province);
        $criteria->compare('Pad_Store.city', $this->Pad_Store->city);
        $criteria->compare('Pad_Store.district', $this->Pad_Store->district);
        $criteria->compare('Pad_Store.status', $this->Pad_Store->status);
                
        return new CActiveDataProvider($this, array(
            'criteria'=>$criteria,
            'pagination'=>array(
                'pageSize'=>10,
            ),
            'sort'=>array(
                'defaultOrder'=>'t.id desc',
                'attributes'=>array(
                    'Pad_Store.phone'=>array(
                        'desc'=>'Pad_Store.phone desc',
                    ),
                    'Pad_Store.name'=>array(
                            'desc'=>'Pad_Store.name desc',
                    ),
                    'Pad_Store.telephone'=>array(
                            'desc'=>'Pad_Store.telephone desc',
                    ),
                    'Pad_Store.province'=>array(
                            'desc'=>'Pad_Store.province desc',
                    ),
                    'Pad_Store.city'=>array(
                            'desc'=>'Pad_Store.city desc',
                    ),
                    'Pad_Store.district'=>array(
                            'desc'=>'Pad_Store.district desc',
                    ),
                    '*'
                ),
            ),
        ));
    }

    /**
     * Returns the static model of the specified AR class.
     * Please note that you should have this exact method in all your CActiveRecord descendants!
     * @param string $className active record class name.
     * @return Pad the static model class
     */
    public static function model($className=__CLASS__)
    {
        return parent::model($className);
    }
    
    /**
     * 保存之前的操作
     * (non-PHPdoc)
     * @see CActiveRecord::beforeSave()
     */
    public function beforeSave()
    {
        if (parent::beforeSave())
        {
            if ($this->getIsNewRecord())
                $this->up_time = $this->add_time = time();
            else
                $this->up_time = time();
            return true;
        }
        return false;
    }
    
    /**
     * 创建展示屏
     * @param unknown $data
     * @param unknown $store_id
     * @param string $scenario
     * @throws Exception
     * @return boolean
     */
    public function createPad($data, $store_id, $scenario = 'create')
    {
        $this->scenario = $scenario;
        $this->attributes = $data;
        $this->store_id = $store_id;
        if ($this->validate())
        {
            $transaction = $this->dbConnection->beginTransaction();
            try
            {
                if ($this->save(false))
                {
                    if ( !Store::model()->updateByPk($store_id, array('pad_count'=>new CDbExpression('`pad_count`+1'))))
                        throw new Exception('保存角色体验店表展示屏统计错误');
                }
                else
                    throw new Exception('保存展示屏表错误');
                $return = true;
                $transaction->commit();
            }
            catch(Exception $e)
            {
                $transaction->rollBack();
                Yii::log($e->getMessage(), 'info', __CLASS__);
            }
            if (isset($return) && $return)
                return true;
        } else 
            Yii::log(var_export($this->getErrors(), true), 'info', __CLASS__);
        return false;
    }
}