<?php
/**
 * 管理员登录控制器
 * @author Changhai Zhan
 *
 */
class LoginController extends OperatorMainController
{
	/**
	 * Declares class-based actions.
	 */
	public function actions()
	{
		//{actions}
		return array(
				//验证码
				'captcha'=>array(
						'class'=>'CCaptchaAction',
						'backColor' =>mt_rand(100,255).mt_rand(100,255).mt_rand(100,255),
						'foreColor'=>mt_rand(100,100).mt_rand(0,100).mt_rand(0,100),
						'maxLength'=>4,
						'minLength'=>4,
						'offset'=>mt_rand(0, 10),
						'padding'=>mt_rand(-5, 5),
						'width'=>120,
						'testLimit'=>3,//使用3次
				),
		);
		//{actions}
	}
	
	/**
	 * 初始化
	 * @see MainController::init()
	 */
	public function init()
	{
		parent::init();
		$this->layout = '/layouts/column';
	}
	
	/**
	 * 登录
	 */
	public function actionIndex($url = '')
	{
		if ( !Yii::app()->operator->isGuest)
			$this->redirect(Yii::app()->homeUrl);
					
		AgentLoginForm::unsetVerify();
		$this->addCss(Yii::app()->baseUrl."/css/operator/login/index.css");
		
		$model = new AgentLoginForm;
		$model->scenario = 'login';
		
		if (isset($_POST['AgentLoginForm']))
		{
			$model->attributes = $_POST['AgentLoginForm'];
			if ($model->validate() && $model->login())
				$this->redirect($url ? $url : Yii::app()->homeUrl);
		}
		$this->render('index', array('model'=>$model));
	}

	/**
	 * 退出当前登录模块
	 */
	public function actionOut()
	{
		Yii::app()->operator->logout(false);
		Yii::app()->operator->loginRequired();
	}
	
	/**
	 * 验证
	 */
	public function actionApply()
	{
		if ( !Yii::app()->operator->isGuest)
			$this->redirect(Yii::app()->homeUrl);
		
		$this->addCss(Yii::app()->baseUrl."/css/operator/login/index.css");
		$model = new AgentLoginForm;
		$model->scenario = 'apply';
		
		if (isset($_POST['AgentLoginForm']))
		{
			$model->attributes = $_POST['AgentLoginForm'];
			if ($model->validate() && $model->sendSms())
				$this->redirect(array('pwd'));
		}
		
		$this->render('apply', array('model'=>$model));	
	}
	
	/**
	 * 设置密码
	 */
	public function actionPwd()
	{
		if ( !Yii::app()->operator->isGuest)
			$this->redirect(Yii::app()->homeUrl);		
		$phone = AgentLoginForm::isVerify();
		if (! $phone)
			$this->redirect(array('apply'));
		
		$this->addCss(Yii::app()->baseUrl."/css/operator/login/index.css");
		
		$model = Agent::model()->find('phone=:phone AND status=:status', array(':phone'=>$phone, ':status'=>Agent::status_suc));
		if ( !$model)
		{
			AgentLoginForm::unsetVerify();
			$this->redirect(array('apply'));
		}
		$model->scenario = 'smsSetPwd';

		if (isset($_POST['Agent']))
		{
			$model->attributes = $_POST['Agent'];
			$model->password = $model::pwdEncrypt($model->new_pwd);
			if ($model->save() && AgentLoginForm::unsetVerify())
				$this->redirect(array('index'));
		}
		
		$this->render('pwd', array('model'=>$model));
	}
}